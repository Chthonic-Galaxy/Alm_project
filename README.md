# Сервис Анализатора

Этот сервис обрабатывает данные о продажах из XML, сохраняет их в базе данных PostgreSQL и генерирует аналитические отчеты с помощью большой языковой модели (LLM), в частности Google Gemini. Он использует FastAPI в качестве веб-фреймворка, Celery для асинхронного управления задачами и Redis для кэширования.

## Содержание

- [Функциональность](#функциональность)
- [Архитектура](#архитектура)
- [Установка и настройка](#установка-и-настройка)
- [Использование](#использование)
- [API Endpoints](#api-endpoints)
- [Тестирование](#тестирование)
- [Обработка ошибок](#обработка-ошибок)
- [Конфигурация](#конфигурация)
- [Структура проекта](#структура-проекта)
- [Вклад в проект](#вклад-в-проект)
- [Лицензия](#лицензия)

## Функциональность

- Парсинг данных о продажах из XML.
- Хранение данных о продажах в PostgreSQL.
- Генерация аналитических отчетов с помощью Google Gemini.
- Асинхронная генерация отчетов с Celery.
- Кэширование отчетов с Redis.
- Обработка ошибок и логирование.
- Модульное и интеграционное тестирование.
- Докеризация для упрощенного развертывания.

## Архитектура

Сервис состоит из следующих компонентов:

- **Web API (FastAPI):** Обрабатывает входящие запросы, запускает задачи Celery и отправляет ответы.
- **Celery Worker:** Выполняет асинхронные задачи генерации отчетов.
- **База данных PostgreSQL:** Хранит данные о продажах.
- **Redis:** Кэширует сгенерированные отчеты.
- **Google Gemini:** LLM для генерации аналитических отчетов.

## Установка и настройка

1. **Клонируйте репозиторий:**
   ```bash
   git clone <URL репозитория>
   ```

2. **Перейдите в директорию проекта:**
   ```bash
   cd analyzerservice
   ```

3. **Создайте виртуальное окружение:**
   ```bash
   poetry shell
   ```

4. **Установите зависимости:**
   ```bash
   poetry install
   ```

5. **Настройте переменные окружения:**
    Создайте файл `.env` в корневой директории и установите следующие переменные:

    ```
    GEMINI_API=<ваш_ключ_API_Gemini>
    PGUSERNAME=<имя_пользователя_PostgreSQL>
    PGPASSWORD=<пароль_PostgreSQL>
    PGHOST=<хост_PostgreSQL>
    PGPORT=<порт_PostgreSQL>
    PGDATABASE=<название_базы_данных_PostgreSQL>
    ```
6. **Выполните миграции базы данных:** *Инструкции, если применимо*

## Использование

1. **Запустите сервисы:**
   ```bash
   docker-compose up -d --build
   ```

2. **Откройте документацию API:** Перейдите по адресу `http://localhost:8000/docs` в вашем браузере.

## API Endpoints

### API Explorer

| Метод | Путь                 | Описание                                                                     |
| :----- | :------------------- | :----------------------------------------------------------------------------- |
| POST    | `/explorer/xml/get-xml` | Загружает XML данные по URL и сохраняет их в базе данных.                     |
| GET     | `/explorer/`          | Возвращает все данные о продуктах из базы данных.                                  |
| DELETE  | `/explorer/{product_id}` | Удаляет продукт по ID.                                                       |

### API Генератора Отчетов

| Метод | Путь            | Описание                                                                |
| :----- | :------------- | :------------------------------------------------------------------------ |
| POST    | `/report-generator/` | Запускает генерацию отчета для указанной даты.                             |

## Тестирование

1. Запуск тестов:
   ```bash
   poetry run pytest
   ```
2. Отчет о покрытии кода:
   ```bash
   poetry run coverage report
   ```

## Обработка ошибок

Сервис включает в себя комплексную обработку ошибок и логирование. Ошибки записываются в консоль и в лог-файл (`/var/log/info.log` внутри Docker-контейнера). HTTP-исключения возбуждаются с соответствующими кодами состояния и подробными сообщениями об ошибках. Специальные типы ошибок, такие как `Missing`, используются для указания на то, что запрошенный ресурс не найден.

## Конфигурация

Конфигурация управляется через переменные окружения, хранящиеся в файле `.env`. Подробнее см. [Установка и настройка](#установка-и-настройка).

## Структура проекта

```
analyzerservice/
├── analyzerservice/
│   ├── config.py        # Конфигурация и настройка Gemini
│   ├── data/           # Слой доступа к данным
│   │   ├── dbbase.py     # Модели базы данных и управление сессиями
│   │   ├── data_loader.py # Функции для загрузки данных из XML
│   │   └── report_generator.py # Функции для генерации отчетов
│   ├── errors.py       # Пользовательские классы исключений
│   ├── model/          # Pydantic модели для валидации данных
│   │   └── schemas.py    # Схемы данных
│   ├── service/        # Слой бизнес-логики
│   │   ├── data_loader.py # Сервисные функции для загрузки данных
│   │   └── report_generator.py # Сервисные функции для генерации отчетов
│   ├── src/            # Основной код приложения
│   │   ├── cache.py      # Логика кэширования
│   │   ├── celery_app.py # Конфигурация приложения Celery
│   │   └── main.py      # Точка входа приложения FastAPI
│   ├── web/            # Точки входа API
│   │   ├── data_loading_api.py # Точки входа API Explorer
│   │   └── report_generation_api.py # Точки входа API генератора отчетов
│   ├── fake            # Содержит примеры и XML-файлы для тестирования
│   ├── __init__.py
├── tests/               # Набор тестов
│   ├── unit/            # Директория модульных тестов
│   │   ├── data/        # Модульные тесты для слоя данных
│   │   │   ├── test_analiser_data.py
│   │   │   └── test_explorer_data.py
│   │   ├── web/       # Модульные тесты для веб-слоя
│   │   │   ├── test_explorer_web.py
│   │   │   └── test_analiser_web.py
│   │   └── service/     # Модульные тесты для сервисного слоя
│   │       └── test_explorer_service.py
├── .dockerignore       # Файл игнорирования Docker
├── Dockerfile          # Файл Docker
├── docker-compose.yml  # Файл Docker Compose
├── pyproject.toml      # Файл проекта Poetry
├── poetry.lock       # lock файл Poetry
└── README.md           # Этот файл
```

## Вклад в проект

Мы приветствуем вклад в проект! Пожалуйста, следуйте этим шагам:

1. Сделайте форк репозитория.
2. Создайте новую ветку для вашей функции.
3. Внесите свои изменения и зафиксируйте их.
4. Отправьте вашу ветку в ваш форк.
5. Создайте запрос на слияние (pull request).

## Лицензия

Этот проект лицензируется по [лицензии MIT](LICENSE).
```
